<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Welcome to Delta Lake Pyspark Helper Class Documentation! &mdash; Delta Lake Pyspark Helper Class 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="#" class="icon icon-home"> Delta Lake Pyspark Helper Class
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Welcome to Delta Lake Pyspark Helper Class  Documentation!</a></li>
<li><a class="reference internal" href="#step-1-install-jar-files">Step 1 Install Jar Files</a></li>
<li><a class="reference internal" href="#step-2-copy-python-template">Step 2 Copy Python Template</a></li>
<li><a class="reference internal" href="#step-3-examples">Step 3 Examples</a></li>
<li><a class="reference internal" href="#python-class">Python Class</a></li>
<li><a class="reference internal" href="#become-a-contributor">Become a  Contributor  ?</a></li>
<li><a class="reference internal" href="#videos-tutorials">Videos Tutorials</a></li>
<li><a class="reference internal" href="#authors">Authors</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">Delta Lake Pyspark Helper Class</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Welcome to Delta Lake Pyspark Helper Class  Documentation!</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="welcome-to-delta-lake-pyspark-helper-class-documentation">
<h1>Welcome to Delta Lake Pyspark Helper Class  Documentation!<a class="headerlink" href="#welcome-to-delta-lake-pyspark-helper-class-documentation" title="Permalink to this heading"></a></h1>
<p>Delta Lake is the optimized storage layer that provides the foundation for storing data and tables in the Databricks Lakehouse Platform. Delta Lake is open source software that extends Parquet data files with a file-based transaction log for ACID transactions and scalable metadata handling.</p>
<a class="reference external image-reference" href="https://user-images.githubusercontent.com/39345855/203801714-e7050ab0-c597-4718-a709-64ab1fabc7ad.png"><img alt="https://user-images.githubusercontent.com/39345855/203801714-e7050ab0-c597-4718-a709-64ab1fabc7ad.png" src="https://user-images.githubusercontent.com/39345855/203801714-e7050ab0-c597-4718-a709-64ab1fabc7ad.png" /></a>
<p>This Python Class will have you up and running with Delta lakes in no time. There are methods, particularly for beginners, that make it simple to insert update delete into delta lake.</p>
<div class="toctree-wrapper compound">
</div>
</section>
<section id="step-1-install-jar-files">
<h1>Step 1 Install Jar Files<a class="headerlink" href="#step-1-install-jar-files" title="Permalink to this heading"></a></h1>
<p>Upload JAR files on S3 Bucket and then add the path in your glue script as shown in image and copy paste the code and make sure to change base s3 path</p>
<p><a href="#id5"><span class="problematic" id="id6">`Link https://repo1.maven.org/maven2/io/delta/delta-core_2.12/1.0.0/delta-core_2.12-1.0.0.jar`_</span></a></p>
<a class="reference external image-reference" href="https://user-images.githubusercontent.com/39345855/203795334-ede5f648-be37-4a39-a07d-76b6d791a2a1.png"><img alt="https://user-images.githubusercontent.com/39345855/203795334-ede5f648-be37-4a39-a07d-76b6d791a2a1.png" src="https://user-images.githubusercontent.com/39345855/203795334-ede5f648-be37-4a39-a07d-76b6d791a2a1.png" /></a>
</section>
<section id="step-2-copy-python-template">
<h1>Step 2 Copy Python Template<a class="headerlink" href="#step-2-copy-python-template" title="Permalink to this heading"></a></h1>
<p>Copy paste the Python Template in your Glue code and start using it Refer to examples shown below</p>
<p>Go TO Section Python Class and Copy Entire Class
<span class="xref std std-ref">Python Class</span></p>
</section>
<section id="step-3-examples">
<h1>Step 3 Examples<a class="headerlink" href="#step-3-examples" title="Permalink to this heading"></a></h1>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkConf</span><span class="p">,</span> <span class="n">SparkContext</span>
<span class="kn">from</span> <span class="nn">awsglue.job</span> <span class="kn">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">awsglue.utils</span> <span class="kn">import</span> <span class="n">getResolvedOptions</span>
<span class="kn">from</span> <span class="nn">awsglue.dynamicframe</span> <span class="kn">import</span> <span class="n">DynamicFrame</span>
<span class="kn">from</span> <span class="nn">awsglue.context</span> <span class="kn">import</span> <span class="n">GlueContext</span>

<span class="c1"># Creating Instance</span>
<span class="c1"># This will be the path where your delta lake already exists or where you want to build one.</span>
<span class="n">helper</span> <span class="o">=</span> <span class="n">DeltaLakeHelper</span><span class="p">(</span><span class="n">delta_lake_path</span><span class="o">=</span><span class="s2">&quot;s3a://glue-learn-begineers/deltalake/delta_table&quot;</span><span class="p">)</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">getResolvedOptions</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;JOB_NAME&quot;</span><span class="p">])</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">spark</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>
<span class="n">glueContext</span> <span class="o">=</span> <span class="n">GlueContext</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">glueContext</span><span class="p">)</span>
<span class="n">job</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;JOB_NAME&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">)</span>

<span class="c1"># ====================================================</span>
<span class="sd">&quot;&quot;&quot;Create Spark Data Frame &quot;&quot;&quot;</span>
<span class="c1"># ====================================================</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">impleDataUpd</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;this is inser 1 &quot;</span><span class="p">,</span> <span class="s2">&quot;Sales&quot;</span><span class="p">,</span> <span class="s2">&quot;RJ&quot;</span><span class="p">,</span> <span class="mi">81000</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">23000</span><span class="p">,</span> <span class="mi">827307999</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;this is inser 2&quot;</span><span class="p">,</span> <span class="s2">&quot;Engineering&quot;</span><span class="p">,</span> <span class="s2">&quot;RJ&quot;</span><span class="p">,</span> <span class="mi">79000</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">15000</span><span class="p">,</span> <span class="mi">1627694678</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;this is inser 3&quot;</span><span class="p">,</span> <span class="s2">&quot;Engineering&quot;</span><span class="p">,</span> <span class="s2">&quot;RJ&quot;</span><span class="p">,</span> <span class="mi">79000</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">15000</span><span class="p">,</span> <span class="mi">1627694678</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;emp_id&quot;</span><span class="p">,</span> <span class="s2">&quot;employee_name&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;salary&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;bonus&quot;</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">]</span>
<span class="n">df_write</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
<span class="n">helper</span><span class="o">.</span><span class="n">insert_overwrite_records_delta_lake</span><span class="p">(</span><span class="n">spark_df</span><span class="o">=</span><span class="n">df_write</span><span class="p">)</span>

<span class="c1"># ====================================================</span>
<span class="sd">&quot;&quot;&quot;READ FROM DELTA LAKE  &quot;&quot;&quot;</span>
<span class="c1"># ====================================================</span>
<span class="n">df_read</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">read_delta_lake</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;READ&quot;</span><span class="p">,</span> <span class="n">df_read</span><span class="o">.</span><span class="n">show</span><span class="p">())</span>

<span class="c1"># ====================================================</span>
<span class="sd">&quot;&quot;&quot;UPDATE DELTA LAKE&quot;&quot;&quot;</span>
<span class="c1"># ====================================================</span>
<span class="n">helper</span><span class="o">.</span><span class="n">update_records_delta_lake</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s2">&quot;emp_id = &#39;3&#39;&quot;</span><span class="p">,</span>
                                 <span class="n">value_to_set</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;employee_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;THIS WAS UPDATE ON DELTA LAKE&#39;&quot;</span><span class="p">})</span>

<span class="c1"># ====================================================</span>
<span class="sd">&quot;&quot;&quot; DELETE DELTA LAKE&quot;&quot;&quot;</span>
<span class="c1"># ====================================================</span>
<span class="n">helper</span><span class="o">.</span><span class="n">delete_records_delta_lake</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s2">&quot;emp_id = &#39;4&#39;&quot;</span><span class="p">)</span>

<span class="c1"># ====================================================</span>
<span class="sd">&quot;&quot;&quot; FIND ONE AND UPDATE OR UPSERT DELTA LAKE &quot;&quot;&quot;</span>
<span class="c1"># ====================================================</span>
<span class="n">new_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;this is update on delta lake &quot;</span><span class="p">,</span> <span class="s2">&quot;Sales&quot;</span><span class="p">,</span> <span class="s2">&quot;RJ&quot;</span><span class="p">,</span> <span class="mi">81000</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">23000</span><span class="p">,</span> <span class="mi">827307999</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;This should be append &quot;</span><span class="p">,</span> <span class="s2">&quot;Engineering&quot;</span><span class="p">,</span> <span class="s2">&quot;RJ&quot;</span><span class="p">,</span> <span class="mi">79000</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">15000</span><span class="p">,</span> <span class="mi">1627694678</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;emp_id&quot;</span><span class="p">,</span> <span class="s2">&quot;employee_name&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;salary&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;bonus&quot;</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">]</span>
<span class="n">usr_up_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">new_data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

<span class="n">helper</span><span class="o">.</span><span class="n">upsert_records_delta_lake</span><span class="p">(</span><span class="n">old_data_key</span><span class="o">=</span><span class="s1">&#39;emp_id&#39;</span><span class="p">,</span>
                                 <span class="n">new_data_key</span><span class="o">=</span><span class="s1">&#39;emp_id&#39;</span><span class="p">,</span>
                                 <span class="n">new_spark_df</span><span class="o">=</span><span class="n">usr_up_df</span><span class="p">)</span>

<span class="c1"># ====================================================</span>
<span class="sd">&quot;&quot;&quot; Compaction DELTA Prune Older Version and Create larger Files &quot;&quot;&quot;</span>
<span class="c1"># ====================================================</span>
<span class="n">helper</span><span class="o">.</span><span class="n">compact_table</span><span class="p">(</span><span class="n">num_of_files</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">helper</span><span class="o">.</span><span class="n">delete_older_files_versions</span><span class="p">()</span>

<span class="c1"># ====================================================</span>
<span class="sd">&quot;&quot;&quot; Create Manifest File for Athena &quot;&quot;&quot;</span>
<span class="c1"># ====================================================</span>
<span class="n">helper</span><span class="o">.</span><span class="n">generate_manifest_files</span><span class="p">()</span>

<span class="n">job</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="python-class">
<h1>Python Class<a class="headerlink" href="#python-class" title="Permalink to this heading"></a></h1>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="k">try</span><span class="p">:</span>
<span class="linenos">  2</span>    <span class="kn">import</span> <span class="nn">os</span>
<span class="linenos">  3</span>    <span class="kn">import</span> <span class="nn">sys</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span>    <span class="kn">import</span> <span class="nn">pyspark</span>
<span class="linenos">  6</span>    <span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkConf</span><span class="p">,</span> <span class="n">SparkContext</span>
<span class="linenos">  7</span>    <span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="linenos">  8</span>    <span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">asc</span><span class="p">,</span> <span class="n">desc</span>
<span class="linenos">  9</span>    <span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 10</span>    <span class="kn">from</span> <span class="nn">delta.tables</span> <span class="kn">import</span> <span class="o">*</span>
<span class="linenos"> 11</span>    <span class="kn">from</span> <span class="nn">delta.tables</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All modules are loaded .....&quot;</span><span class="p">)</span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 16</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some modules are missing </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="k">class</span> <span class="nc">DeltaLakeHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos"> 20</span>    <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 21</span><span class="sd">    Delta Lakes Python helper class that aids in basic operations such as inserting, updating, deleting, merging, removing older files and versions, and generating Athena manifest files.</span>
<span class="linenos"> 22</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_lake_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_spark_session</span><span class="p">()</span>
<span class="linenos"> 27</span>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_lake_path</span> <span class="o">=</span> <span class="n">delta_lake_path</span>
<span class="linenos"> 28</span>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_df</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span>    <span class="k">def</span> <span class="nf">generate_manifest_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 31</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="sd">        Generates Manifest file for Athena</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="sd">        :return: Bool</span>
<span class="linenos"> 36</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 37</span>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_df</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s2">&quot;symlink_format_manifest&quot;</span><span class="p">)</span>
<span class="linenos"> 38</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span>    <span class="k">def</span> <span class="nf">__generate_delta_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 41</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 42</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 43</span>                <span class="bp">self</span><span class="o">.</span><span class="n">delta_df</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_lake_path</span><span class="p">)</span>
<span class="linenos"> 44</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 45</span>            <span class="k">pass</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>    <span class="k">def</span> <span class="nf">compact_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_of_files</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="linenos"> 48</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="sd">        Converts smaller parquert files into larger Files</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="sd">        :param num_of_files: Int</span>
<span class="linenos"> 53</span><span class="sd">        :return: Bool</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 56</span>        <span class="n">df_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span> \
<span class="linenos"> 57</span>            <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_lake_path</span><span class="p">)</span> \
<span class="linenos"> 58</span>            <span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">)</span> \
<span class="linenos"> 59</span>            <span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;dataChange&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span> \
<span class="linenos"> 60</span>            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span> \
<span class="linenos"> 61</span>            <span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span> \
<span class="linenos"> 62</span>            <span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_lake_path</span><span class="p">)</span>
<span class="linenos"> 63</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span>    <span class="k">def</span> <span class="nf">delete_older_files_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 66</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="sd">        Deletes Older Version and calls vacuum(0)</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="sd">        :return: Bool</span>
<span class="linenos"> 71</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 72</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__generate_delta_df</span><span class="p">()</span>
<span class="linenos"> 73</span>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_df</span><span class="o">.</span><span class="n">vacuum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 74</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>    <span class="k">def</span> <span class="nf">insert_overwrite_records_delta_lake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spark_df</span><span class="p">,</span> <span class="n">max_record_per_file</span><span class="o">=</span><span class="s1">&#39;10000&#39;</span><span class="p">):</span>
<span class="linenos"> 77</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 78</span><span class="sd">        Inserts into Delta Lake</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="sd">        :param spark_df: Pyspark Dataframe</span>
<span class="linenos"> 81</span><span class="sd">        :param max_record_per_file: str ie max_record_per_file= &quot;10000&quot;</span>
<span class="linenos"> 82</span><span class="sd">        :return:Bool</span>
<span class="linenos"> 83</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 84</span>        <span class="n">spark_df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span> \
<span class="linenos"> 85</span>            <span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span> \
<span class="linenos"> 86</span>            <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;maxRecordsPerFile&quot;</span><span class="p">,</span> <span class="n">max_record_per_file</span><span class="p">)</span> \
<span class="linenos"> 87</span>            <span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_lake_path</span><span class="p">)</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span>    <span class="k">def</span> <span class="nf">append_records_delta_lake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spark_df</span><span class="p">,</span> <span class="n">max_record_per_file</span><span class="o">=</span><span class="s2">&quot;10000&quot;</span><span class="p">):</span>
<span class="linenos"> 92</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="sd">        Append data into Delta lakes</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="sd">        :param spark_df: Pyspark Dataframe</span>
<span class="linenos"> 97</span><span class="sd">        :param max_record_per_file: str ie max_record_per_file= &quot;10000&quot;</span>
<span class="linenos"> 98</span><span class="sd">        :return: Bool</span>
<span class="linenos"> 99</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">100</span>        <span class="n">spark_df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span> \
<span class="linenos">101</span>            <span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s1">&#39;append&#39;</span><span class="p">)</span> \
<span class="linenos">102</span>            <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;maxRecordsPerFile&quot;</span><span class="p">,</span> <span class="n">max_record_per_file</span><span class="p">)</span> \
<span class="linenos">103</span>            <span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_lake_path</span><span class="p">)</span>
<span class="linenos">104</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">105</span>
<span class="linenos">106</span>    <span class="k">def</span> <span class="nf">update_records_delta_lake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value_to_set</span><span class="o">=</span><span class="p">{}):</span>
<span class="linenos">107</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="sd">        Set the value on delta lake</span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="sd">        :param condition : Str Example:  condition=&quot;emp_id = &#39;3&#39;&quot;</span>
<span class="linenos">112</span><span class="sd">        :param value_to_set: Dict IE  value_to_set={&quot;employee_name&quot;: &quot;&#39;THIS WAS UPDATE ON DELTA LAKE&#39;&quot;}</span>
<span class="linenos">113</span><span class="sd">        :return: Bool</span>
<span class="linenos">114</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">115</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__generate_delta_df</span><span class="p">()</span>
<span class="linenos">116</span>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_df</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">value_to_set</span><span class="p">)</span>
<span class="linenos">117</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">118</span>
<span class="linenos">119</span>    <span class="k">def</span> <span class="nf">upsert_records_delta_lake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_data_key</span><span class="p">,</span> <span class="n">new_data_key</span><span class="p">,</span> <span class="n">new_spark_df</span><span class="p">):</span>
<span class="linenos">120</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">121</span>
<span class="linenos">122</span><span class="sd">        Find one and update into delta lake</span>
<span class="linenos">123</span><span class="sd">        If records is found it will update if not it will insert into delta lakes</span>
<span class="linenos">124</span><span class="sd">        See Examples on How to use this</span>
<span class="linenos">125</span>
<span class="linenos">126</span><span class="sd">        :param old_data_key: Key is nothing but Column on which you want to merge or upsert data into delta lake</span>
<span class="linenos">127</span><span class="sd">        :param new_data_key: Key is nothing but Column on which you want to merge or upsert data into delta lake</span>
<span class="linenos">128</span><span class="sd">        :param new_spark_df: Spark DataFrame</span>
<span class="linenos">129</span><span class="sd">        :return: Bool</span>
<span class="linenos">130</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">131</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__generate_delta_df</span><span class="p">()</span>
<span class="linenos">132</span>        <span class="n">dfUpdates</span> <span class="o">=</span> <span class="n">new_spark_df</span>
<span class="linenos">133</span>
<span class="linenos">134</span>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;oldData&#39;</span><span class="p">)</span> \
<span class="linenos">135</span>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfUpdates</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;newData&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;oldData.</span><span class="si">{</span><span class="n">old_data_key</span><span class="si">}</span><span class="s1"> = newData.</span><span class="si">{</span><span class="n">new_data_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> \
<span class="linenos">136</span>            <span class="o">.</span><span class="n">whenMatchedUpdateAll</span><span class="p">()</span> \
<span class="linenos">137</span>            <span class="o">.</span><span class="n">whenNotMatchedInsertAll</span><span class="p">()</span> \
<span class="linenos">138</span>            <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="linenos">139</span>
<span class="linenos">140</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">141</span>
<span class="linenos">142</span>    <span class="k">def</span> <span class="nf">delete_records_delta_lake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="linenos">143</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">144</span>
<span class="linenos">145</span><span class="sd">        Set the value on delta lake</span>
<span class="linenos">146</span>
<span class="linenos">147</span><span class="sd">        :param condition:Str IE condition=&quot;emp_id = &#39;4&#39;&quot;</span>
<span class="linenos">148</span><span class="sd">        :return:Bool</span>
<span class="linenos">149</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">150</span>        <span class="bp">self</span><span class="o">.</span><span class="n">__generate_delta_df</span><span class="p">()</span>
<span class="linenos">151</span>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_df</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<span class="linenos">152</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">153</span>
<span class="linenos">154</span>    <span class="k">def</span> <span class="nf">read_delta_lake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">155</span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">156</span>
<span class="linenos">157</span><span class="sd">        Reads from Delta lakes</span>
<span class="linenos">158</span>
<span class="linenos">159</span><span class="sd">        :return: Spark DF</span>
<span class="linenos">160</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">161</span>        <span class="n">df_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_lake_path</span><span class="p">)</span>
<span class="linenos">162</span>        <span class="k">return</span> <span class="n">df_read</span>
<span class="linenos">163</span>
<span class="linenos">164</span>    <span class="k">def</span> <span class="nf">__create_spark_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">165</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
<span class="linenos">166</span>            <span class="o">.</span><span class="n">builder</span> \
<span class="linenos">167</span>            <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.extensions&quot;</span><span class="p">,</span> <span class="s2">&quot;io.delta.sql.DeltaSparkSessionExtension&quot;</span><span class="p">)</span> \
<span class="linenos">168</span>            <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.databricks.delta.retentionDurationCheck.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span> \
<span class="linenos">169</span>            <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.sql.catalog.spark_catalog&quot;</span><span class="p">,</span> <span class="s2">&quot;org.apache.spark.sql.delta.catalog.DeltaCatalog&quot;</span><span class="p">)</span> \
<span class="linenos">170</span>            <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="linenos">171</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span>
</pre></div>
</div>
</section>
<section id="become-a-contributor">
<h1>Become a  Contributor  ?<a class="headerlink" href="#become-a-contributor" title="Permalink to this heading"></a></h1>
<p>Please feel free to fork the project, make your changes, and submit a merge request.
Github : <a class="reference external" href="https://github.com/soumilshah1995/Delta-Lake-Pyspark-Helper-Class">https://github.com/soumilshah1995/Delta-Lake-Pyspark-Helper-Class</a></p>
</section>
<section id="videos-tutorials">
<h1>Videos Tutorials<a class="headerlink" href="#videos-tutorials" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p>How to Write | Read | Query Delta lake using AWS Glue and Athena for Queries for Beginners <a class="reference external" href="https://www.youtube.com/watch?v=4HUgZksc1eE">https://www.youtube.com/watch?v=4HUgZksc1eE</a></p></li>
<li><p>Getting started with Delta lakes Pyspark and AWS Glue (Glue Connector) <a class="reference external" href="https://www.youtube.com/watch?v=xpU6JPWZ9Pw">https://www.youtube.com/watch?v=xpU6JPWZ9Pw</a></p></li>
<li><p>INSERT | UPDATE <a href="#id3"><span class="problematic" id="id4">|DELETE|</span></a> READ | CRUD <a href="#id1"><span class="problematic" id="id2">|</span></a>on Delta lake(S3) using Glue PySpark Custom Jar Files &amp; Athena  <a class="reference external" href="https://www.youtube.com/watch?v=M0Q9AwnuW-w">https://www.youtube.com/watch?v=M0Q9AwnuW-w</a></p></li>
<li><p>How do I use Glue to convert existing small parquet files to larger parquet files on Delta Lake <a class="reference external" href="https://www.youtube.com/watch?v=AGWcGlraqEg&amp;t=455s">https://www.youtube.com/watch?v=AGWcGlraqEg&amp;t=455s</a></p></li>
<li><p>Upsert | Find One and Update in Delta Lake Using Glue Pyspark and Convert Small File into Large File <a class="reference external" href="https://youtu.be/861mVVgmXw4">https://youtu.be/861mVVgmXw4</a></p></li>
</ul>
</section>
<section id="authors">
<h1>Authors<a class="headerlink" href="#authors" title="Permalink to this heading"></a></h1>
<p>Soumil Nitin Shah</p>
<p>I earned a Bachelor of Science in Electronic Engineering and a double master’s in Electrical and Computer Engineering. I have extensive expertise in developing scalable and high-performance software applications in Python. I have a YouTube channel where I teach people about Data Science, Machine learning, Elastic search, and AWS. I work as data collection and processing Team Lead at Jobtarget where I spent most of my time developing Ingestion Framework and creating microservices and scalable architecture on AWS. I have worked with a massive amount of data which includes creating data lakes (1.2T) optimizing data lakes query by creating a partition and using the right file format and compression. I have also developed and worked on a streaming application for ingesting real-time streams data via kinesis and firehose to elastic search</p>
<p>Website : <a class="reference external" href="http://soumilshah.com/">http://soumilshah.com/</a></p>
<p>Github : <a class="reference external" href="https://github.com/">https://github.com/</a></p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Soumil Shah.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>